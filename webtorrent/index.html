<!DOCTYPE html>
<html>

<head>
  <title>基于 WebTorrent 下载文件</title>
</head>

<body>
  <h1>
    基于 WebTorrent 下载文件
  </h1>

  <style>
    #torrentInput {
      width: 80%;
    }
  </style>
  <form>
    <label for="torrentId">输入磁力链接： </label>
    <input id="torrentInput" name="torrentId" , placeholder="magnet:" value="" />
    <button type="submit">开始下载</button>
    <div>
      <button
        onclick="download('magnet:?xt=urn:btih:08ada5a7a6183aae1e09d831df6748d566095a10&dn=Sintel&tr=udp%3A%2F%2Fexplodie.org%3A6969&tr=udp%3A%2F%2Ftracker.coppersurfer.tk%3A6969&tr=udp%3A%2F%2Ftracker.empire-js.us%3A1337&tr=udp%3A%2F%2Ftracker.leechers-paradise.org%3A6969&tr=udp%3A%2F%2Ftracker.opentrackr.org%3A1337&tr=wss%3A%2F%2Ftracker.btorrent.xyz&tr=wss%3A%2F%2Ftracker.fastcast.nz&tr=wss%3A%2F%2Ftracker.openwebtorrent.com&ws=https%3A%2F%2Fwebtorrent.io%2Ftorrents%2F&xs=https%3A%2F%2Fwebtorrent.io%2Ftorrents%2Fsintel.torrent')">测试官方链接</button>
    </div>

    <button onclick="reload()">刷新页面</button>
  </form>

  <div class="log"></div>

  <!-- Include the latest version of WebTorrent -->
  <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>

  <script>
    document.querySelector("form").addEventListener("submit", function (e) {
      e.preventDefault(); // Prevent page refresh

      const torrentId = document.querySelector(
        "form input[name=torrentId]"
      ).value;

      download(torrentId);
    });

    function download(torrentId) {
      log(torrentId);
      log("开始解析磁力链接，请稍等……");
      const client = new WebTorrent();

      client.on("error", function (err) {
        console.error("ERROR: " + err.message);
      });

      log('本地 peerId: ' + client.peerId);

      client.add(torrentId, onTorrent);
    }

    function onTorrent(torrent) {
      log("Got torrent metadata!");
      log(
        "Torrent info hash: " +
        torrent.infoHash +
        " " +
        '<a href="' +
        torrent.magnetURI +
        '" target="_blank">[Magnet URI]</a> ' +
        '<a href="' +
        torrent.torrentFileBlobURL +
        '" target="_blank" download="' +
        torrent.name +
        '.torrent">[Download .torrent]</a>'
      );

      // Print out progress every 5 seconds
      const interval = setInterval(function () {
        log("Progress: " + (torrent.progress * 100).toFixed(1) + "%");
        log('numPeers: ' + torrent.wires.length);

        torrent.wires.forEach(wire => {
          log(`已从节点 ${wire.peerId} 共下载数据 ${(wire.downloaded / (1024 * 1024)).toFixed(2)}MB ===，下载速度：${(wire.downloadSpeed() / (1024 * 1024)).toFixed(2)}MB/s`);
        });

      }, 1000);

      torrent.on("done", function () {
        log("Progress: 100%");
        clearInterval(interval);
      });

      // Render all files into to the page
      torrent.files.forEach(function (file) {
        file.appendTo(".log");
        log(
          '(Blob URLs only work if the file is loaded from a server. "http//localhost" works. "file://" does not.)'
        );
        file.getBlobURL(function (err, url) {
          if (err) return log(err.message);
          log("File done.");
          log(
            '<a href="' + url + '">Download full file: ' + file.name + "</a>"
          );
        });
      });
    }

    function log(str) {
      const p = document.createElement("p");
      p.innerHTML = str;
      document.querySelector(".log").appendChild(p);
    }

    function reload() {
      window.location.reload();
    }
  </script>
</body>

</html>